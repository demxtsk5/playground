---
- name: Install MetalLB
  hosts:
    - localhost
  collections:
    - kubernetes.core

  tasks:
    - name: Create MetalLB namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: metallb-system
          
    - name: Deploy MetalLB components
      kubernetes.core.k8s:
        state: present
        definition: 
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
            - https://raw.githubusercontent.com/metallb/metallb/main/manifests/metallb.yaml

    - name: Create MetalLB ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            namespace: metallb-system
            name: config
          data:
            config: |
              address-pools:
              - name: default
                protocol: layer2
                addresses:
                - {{ lb_ip_range }}
